{% extends 'base.html' %}
{% import 'bootstrap/wtf.html' as wtf %}

{% block app_content %}
    <h1>Quiz {{ quiz_id }}</h1>

    <div id="surveyElement"></div>
    <div id="questionResult"></div>
    <div id="surveyResult"></div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <!-- SurveyJS -->
    <script src="https://surveyjs.azureedge.net/1.0.49/survey.jquery.min.js"></script>

    <script type="text/javascript" charset="utf8">
        $(document).ready( function () {
            Survey.StylesManager.applyTheme("bootstrap");
            Survey.defaultBootstrapCss.navigationButton = "btn btn-green";
            window.survey = new Survey.Model({
                showProgressBar: "bottom",
                showTimerPanel: "top",
                maxTimeToFinishPage: 30,
                //questionsOrder: "random",
                firstPageIsStarted: true,
                startSurveyText: "Start Quiz",
                completedHtml: "<h4>You have answered correctly <b>{correctedAnswers}</b> questions from <b>{questionCount}</b>.</h4>"
            });

            var jqxhr = $.getJSON( "/api/quiz/" + {{ quiz_id }}, function() {
              console.log( "success" );
            })
              .done(function( quiz ) {
                var questions = quiz["questions"];

                survey.title = quiz["name"];
                survey.maxTimeToFinish = survey.maxTimeToFinishPage * questions.length;

                var q = survey.addNewPage().addNewQuestion("html");
                q.html = `You are about to start a quiz.<br/> You have
                  ${survey.maxTimeToFinishPage} seconds for every page and
                  ${(survey.maxTimeToFinish / 60)} minutes for the whole survey
                  of ${questions.length} questions.<br/> Please click the <b>'
                  ${survey.startSurveyText}'</b> button when you are ready.`;

                questions.forEach( function( question ) {
                    var page = survey.addNewPage();
                    var q = page.addNewQuestion(
                        "text", question["id"].toString());
                    q.title = question["prompt"];
                    q.correctAnswer = question["correct_answer"];
                });
                console.log( "second success" );
              })
              .fail(function( errMsg ) {
                alert("error");
                console.log(errMsg);
                console.log( "error" );
              })
              .always(function() {
                console.log( "complete" );
              });

            survey
                .onIsAnswerCorrect
                .add(function (options) {
                  console.log(options);
                  console.log(options.question);
                  console.log(options.result);
            //        document
            //            .querySelector('#questionResult')
            //            .innerHTML = "result: " + JSON.stringify(result);
                });

            survey
                .onComplete
                .add(function (result) {
                    //By default clear methods clear all data and go to the first page
                    //Here we tell survey keep the data by passing the first parameter as false
                    //result.clear(false);
                    //Put survey into read-only mode
                    //result.mode = "display";
                    //Set survey to single page
                    //result.isSinglePage = true;

                    console.log("time spent: " + survey.timeSpent);

                    //document
                    //    .querySelector('#surveyResult')
                    //    .innerHTML = "result: " + result_string;
                    let post_data = {
                      "score": survey.getCorrectedAnswerCount(),
                      "quiz_id": {{ quiz_id }},
                      "user_id": {{ user_id }},
                      "result": JSON.stringify(result.data)
                      //"result": JSON.stringify(result.data)
                    };

                    console.log(post_data);

                    var jqxhr = $.post({
                      url: "/api/score",
                      contentType: "application/json; charset=UTF-8",
                      data: JSON.stringify(post_data),
                      success: function() {
                        //alert( "success" );
                      }})
                      .done(function( response ) {
                        //alert( "second success" );
                      })
                      .fail(function( errMsg ) {
                        alert("error");
                        console.log(errMsg.responseText);
                        console.log( "error" );
                      })
                      .always(function() {
                        //alert( "finished" );
                      });
                });

            $("#surveyElement").Survey({model: survey});

        } );
    </script>
{% endblock scripts %}
